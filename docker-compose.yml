services:
  # ==========================================================================
  # SHARED INFRASTRUCTURE - Used by all Copycat services
  # ==========================================================================

  # Firestore Emulator - Document database
  firestore:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: >
      sh -c "gcloud beta emulators firestore start
      --host-port=0.0.0.0:8200"
    ports:
      - "8200:8200"
    environment:
      - FIRESTORE_PROJECT_ID=copycat-local
    volumes:
      - firestore-data:/opt/data/firestore
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - copycat-network

  # PubSub Emulator - Event messaging (PORT 8086 to avoid gcloud auth conflict)
  pubsub:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: gcloud beta emulators pubsub start --host-port=0.0.0.0:8086
    ports:
      - "8086:8086"
    environment:
      - PUBSUB_PROJECT_ID=copycat-local
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - copycat-network

  # PubSub Initializer - Creates all topics and subscriptions
  pubsub-init:
    image: google/cloud-sdk:alpine
    depends_on:
      pubsub:
        condition: service_healthy
    environment:
      - PUBSUB_EMULATOR_HOST=pubsub:8086
      - PUBSUB_PROJECT_ID=copycat-local
    volumes:
      - ./scripts/init-pubsub.sh:/init-pubsub.sh
    entrypoint: ["/bin/sh", "/init-pubsub.sh"]
    networks:
      - copycat-network

  # Cloud Storage Emulator - For frame storage
  storage:
    image: fsouza/fake-gcs-server
    command: -scheme http -port 4443 -external-url http://storage:4443
    ports:
      - "4443:4443"
    volumes:
      - gcs-data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:4443/storage/v1/b"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - copycat-network

  # ==========================================================================
  # COPYCAT MICROSERVICES - Pipeline components
  # ==========================================================================

  # Discovery Service - Finds videos on YouTube (PORT 8081)
  discovery-service:
    build:
      context: ./services/discovery-service
      dockerfile: Dockerfile.dev
    ports:
      - "8081:8080"
    environment:
      - ENVIRONMENT=local
      - GCP_PROJECT_ID=copycat-local  # For emulator (Firestore/PubSub)
      - GCP_REGION=europe-west4
      - YOUTUBE_PROJECT_ID=test-project-boris  # For YouTube API quota tracking
      - GOOGLE_APPLICATION_CREDENTIALS=/gcloud/application_default_credentials.json
      - FIRESTORE_EMULATOR_HOST=firestore:8200
      - FIRESTORE_DATABASE_ID=(default)
      - PUBSUB_EMULATOR_HOST=pubsub:8086
      - PUBSUB_TOPIC_DISCOVERED_VIDEOS=discovered-videos
      - YOUTUBE_API_KEY=AIzaSyDajWejhv4JW65PUphNrNrZrwg3bGHxAPk
      - PUBSUB_TIMEOUT_SECONDS=30
    depends_on:
      firestore:
        condition: service_healthy
      pubsub:
        condition: service_healthy
      pubsub-init:
        condition: service_completed_successfully
    volumes:
      - ./services/discovery-service/app:/app/app
      - ./services/discovery-service/data:/app/data
      - ~/.config/gcloud:/gcloud:ro  # Mount gcloud credentials
      - ./shared:/shared:ro  # Mount shared config module
    networks:
      - copycat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # API Service - Central API gateway (PORT 8080)
  api-service:
    build:
      context: ./services/api-service
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - GCP_PROJECT_ID=copycat-local  # For emulator (Firestore/PubSub)
      - GCP_REGION=europe-west4
      - GEMINI_PROJECT_ID=copycat-429012  # For Vertex AI/Gemini API
      - GOOGLE_APPLICATION_CREDENTIALS=/gcloud/application_default_credentials.json
      - ENVIRONMENT=local
      - DISCOVERY_SERVICE_URL=http://discovery-service:8080
      - FIRESTORE_EMULATOR_HOST=firestore:8200
      - PUBSUB_EMULATOR_HOST=pubsub:8086
      - PUBSUB_TOPIC_SCAN_READY=scan-ready
      - BIGQUERY_DATASET=copycat_dev
    depends_on:
      firestore:
        condition: service_healthy
      pubsub:
        condition: service_healthy
      pubsub-init:
        condition: service_completed_successfully
      discovery-service:
        condition: service_healthy
    volumes:
      - ./services/api-service/app:/app/app
      - ~/.config/gcloud:/gcloud:ro  # Mount gcloud credentials for Gemini
      - ./shared:/shared:ro  # Mount shared config module
    networks:
      - copycat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Frontend Service - React SPA with Vite dev server (PORT 5173)
  frontend-service:
    build:
      context: ./services/frontend-service
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    environment:
      - API_SERVICE_URL=http://api-service:8080
      - ENVIRONMENT=local
    depends_on:
      api-service:
        condition: service_healthy
    volumes:
      - ./services/frontend-service/app/web/src:/app/src
      - ./services/frontend-service/app/web/public:/app/public
      - ./services/frontend-service/app/web/index.html:/app/index.html
      - ./services/frontend-service/app/web/vite.config.ts:/app/vite.config.ts
    networks:
      - copycat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # Risk Analyzer Service - Adaptive risk scoring and scan scheduling (PORT 8082)
  risk-analyzer-service:
    build:
      context: ./services/risk-analyzer-service
      dockerfile: Dockerfile.dev
    ports:
      - "8082:8080"
    environment:
      - ENVIRONMENT=local
      - GCP_PROJECT_ID=copycat-local
      - GCP_REGION=us-central1
      - FIRESTORE_EMULATOR_HOST=firestore:8200
      - FIRESTORE_DATABASE_ID=(default)
      - PUBSUB_EMULATOR_HOST=pubsub:8086
      - PUBSUB_SUBSCRIPTION_VIDEO_DISCOVERED=risk-analyzer-video-discovered-sub
      - PUBSUB_TOPIC_SCAN_READY=scan-ready
      - PUBSUB_TIMEOUT_SECONDS=30
    depends_on:
      firestore:
        condition: service_healthy
      pubsub:
        condition: service_healthy
      pubsub-init:
        condition: service_completed_successfully
    volumes:
      - ./services/risk-analyzer-service/app:/app/app
      - ./shared:/shared:ro  # Mount shared config module
    networks:
      - copycat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Risk Scorer Service - Filters by risk level (PORT 8083)
  # Uncomment when ready to implement
  # risk-scorer-service:
  #   build:
  #     context: ./services/risk-scorer-service
  #     dockerfile: Dockerfile.dev
  #   ports:
  #     - "8081:8080"
  #   environment:
  #     - ENVIRONMENT=local
  #     - GCP_PROJECT_ID=copycat-local
  #     - FIRESTORE_EMULATOR_HOST=firestore:8200
  #     - PUBSUB_EMULATOR_HOST=pubsub:8085
  #     - PUBSUB_TOPIC_RISK_SCORED=risk-scored-videos
  #   depends_on:
  #     firestore:
  #       condition: service_healthy
  #     pubsub:
  #       condition: service_healthy
  #     pubsub-init:
  #       condition: service_completed_successfully
  #   volumes:
  #     - ./services/risk-scorer-service/app:/app/app
  #   networks:
  #     - copycat-network

  # Chapter Extractor Service - Extracts video chapters (PORT 8082)
  # Uncomment when ready to implement
  # chapter-extractor-service:
  #   build:
  #     context: ./services/chapter-extractor-service
  #     dockerfile: Dockerfile.dev
  #   ports:
  #     - "8082:8080"
  #   environment:
  #     - ENVIRONMENT=local
  #     - GCP_PROJECT_ID=copycat-local
  #     - FIRESTORE_EMULATOR_HOST=firestore:8200
  #     - PUBSUB_EMULATOR_HOST=pubsub:8085
  #   depends_on:
  #     firestore:
  #       condition: service_healthy
  #     pubsub:
  #       condition: service_healthy
  #   volumes:
  #     - ./services/chapter-extractor-service/app:/app/app
  #   networks:
  #     - copycat-network

  # Frame Extractor Service - Captures video frames (PORT 8083)
  # Uncomment when ready to implement
  # frame-extractor-service:
  #   build:
  #     context: ./services/frame-extractor-service
  #     dockerfile: Dockerfile.dev
  #   ports:
  #     - "8083:8080"
  #   environment:
  #     - ENVIRONMENT=local
  #     - GCP_PROJECT_ID=copycat-local
  #     - FIRESTORE_EMULATOR_HOST=firestore:8200
  #     - PUBSUB_EMULATOR_HOST=pubsub:8085
  #     - STORAGE_EMULATOR_HOST=http://storage:4443
  #   depends_on:
  #     firestore:
  #       condition: service_healthy
  #     pubsub:
  #       condition: service_healthy
  #     storage:
  #       condition: service_healthy
  #   volumes:
  #     - ./services/frame-extractor-service/app:/app/app
  #   networks:
  #     - copycat-network

  # Vision Analyzer Service - Analyzes with Gemini 2.5 Flash (PORT 8083)
  vision-analyzer-service:
    build:
      context: ./services/vision-analyzer-service
      dockerfile: Dockerfile.dev
    ports:
      - "8083:8080"
    environment:
      - ENVIRONMENT=local
      - GCP_PROJECT_ID=copycat-local  # Emulator project (Firestore/PubSub)
      - VERTEX_AI_PROJECT_ID=copycat-429012  # Production project (Gemini/Vertex AI)
      - GCP_REGION=europe-west4
      - GOOGLE_APPLICATION_CREDENTIALS=/gcloud/application_default_credentials.json
      - FIRESTORE_EMULATOR_HOST=firestore:8200
      - FIRESTORE_DATABASE_ID=(default)
      - PUBSUB_EMULATOR_HOST=pubsub:8086
      - PUBSUB_SCAN_READY_SUBSCRIPTION=scan-ready-vision-analyzer-sub
      - PUBSUB_FEEDBACK_TOPIC=vision-feedback
      - BIGQUERY_DATASET=copycat_dev
      - GEMINI_MODEL=gemini-2.5-flash
      - GEMINI_LOCATION=us-central1
      - DAILY_BUDGET_USD=260
    depends_on:
      firestore:
        condition: service_healthy
      pubsub:
        condition: service_healthy
      pubsub-init:
        condition: service_completed_successfully
    volumes:
      - ./services/vision-analyzer-service/app:/app/app
      - ~/.config/gcloud:/gcloud:ro  # Mount gcloud credentials for Vertex AI
      - ./shared:/shared:ro  # Mount shared config module
    networks:
      - copycat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

networks:
  copycat-network:
    driver: bridge

volumes:
  firestore-data:  # Persistent storage for Firestore emulator
  gcs-data:  # Persistent storage for Cloud Storage emulator
