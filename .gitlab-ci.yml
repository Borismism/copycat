stages:
  - detect
  - deploy-infra
  - deploy-services

variables:
  TF_IN_AUTOMATION: "true"

.gcp-auth: &gcp-auth
  before_script:
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID_DEV
    - gcloud auth configure-docker europe-west4-docker.pkg.dev

# Detect changes
detect-changes:
  stage: detect
  image: alpine:latest
  script:
    - apk add --no-cache git
    - git fetch origin develop --depth=2 || true
    - CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
    - |
      if echo "$CHANGED_FILES" | grep -q '^terraform/'; then
        echo "DEPLOY_INFRA=true" >> detect.env
      else
        echo "DEPLOY_INFRA=false" >> detect.env
      fi
    - CHANGED_SERVICES=$(echo "$CHANGED_FILES" | grep '^services/' | cut -d'/' -f2 | sort -u | tr '\n' ' ' | xargs)
    - echo "SERVICES=$CHANGED_SERVICES" >> detect.env
    - cat detect.env
  artifacts:
    reports:
      dotenv: detect.env
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/**/*
        - terraform/**/*
        - deploy.sh

# Deploy infrastructure (auto)
deploy-infra:
  stage: deploy-infra
  image: google/cloud-sdk:slim
  <<: *gcp-auth
  script:
    - apt-get update && apt-get install -y unzip
    - curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
    - unzip terraform.zip && mv terraform /usr/local/bin/
    - chmod +x deploy.sh
    - ./deploy.sh infra dev
  needs:
    - job: detect-changes
      optional: true
  rules:
    - if: $DEPLOY_INFRA == "true"
  environment:
    name: dev

# Deploy services (auto)
deploy-services:
  stage: deploy-services
  image: google/cloud-sdk:slim
  <<: *gcp-auth
  script:
    - |
      if [ -z "$SERVICES" ]; then
        echo "No services to deploy"
        exit 0
      fi
    - apt-get update && apt-get install -y unzip curl
    - curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
    - unzip terraform.zip && mv terraform /usr/local/bin/
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - chmod +x deploy.sh
    - |
      for SERVICE in $SERVICES; do
        echo "Deploying $SERVICE to dev..."
        ./deploy.sh $SERVICE dev
      done
  needs:
    - job: detect-changes
      optional: true
  rules:
    - if: $SERVICES != ""
  environment:
    name: dev

# Manual deployment jobs
.manual-deploy:
  when: manual
  stage: deploy-services
  image: google/cloud-sdk:slim
  <<: *gcp-auth
  script:
    - apt-get update && apt-get install -y unzip curl
    - curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
    - unzip terraform.zip && mv terraform /usr/local/bin/
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - chmod +x deploy.sh
    - ./deploy.sh $SERVICE_NAME dev
  environment:
    name: dev

deploy-api-dev:
  extends: .manual-deploy
  variables:
    SERVICE_NAME: api-service

deploy-discovery-dev:
  extends: .manual-deploy
  variables:
    SERVICE_NAME: discovery-service

deploy-risk-analyzer-dev:
  extends: .manual-deploy
  variables:
    SERVICE_NAME: risk-analyzer-service

deploy-vision-analyzer-dev:
  extends: .manual-deploy
  variables:
    SERVICE_NAME: vision-analyzer-service

deploy-frontend-dev:
  extends: .manual-deploy
  variables:
    SERVICE_NAME: frontend-service

deploy-infra-manual:
  extends: .manual-deploy
  variables:
    SERVICE_NAME: infra

deploy-all-dev:
  when: manual
  stage: deploy-services
  image: google/cloud-sdk:slim
  <<: *gcp-auth
  script:
    - apt-get update && apt-get install -y unzip curl
    - curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
    - unzip terraform.zip && mv terraform /usr/local/bin/
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - chmod +x deploy.sh
    - for svc in api-service discovery-service risk-analyzer-service vision-analyzer-service frontend-service; do ./deploy.sh $svc dev; done
  environment:
    name: dev
